from pathlib import Path
from typing import Dict

from PyInquirer import prompt
from ad482.common import steps, tasks
from ad482.common.classroom import OcpClassroomConfig, workspace
from labs.common.userinterface import Console, echo
from labs.grading import Default as GuidedExercise

from .common.constants import KAFKA_CLUSTER_NAME, KAFKA_CLUSTER_NS_SUFFIX

DEFAULT_WORKDIR = Path.home().joinpath('AD482')
DEFAULT_KAFKA_CERT_PATH = DEFAULT_WORKDIR.joinpath('ca.cert')


class EDASetup(GuidedExercise):
    __LAB__ = "eda-setup"

    """
    Configures lab environment

    Configures the workspace directory.
    Saves the config in the $HOME/.grading/ad482-workspace.json file
    """

    def start(self):
        configure_workspace()
        items = [
            steps.check_ocp_api(),
            steps.check_ocp_credentials(),
            steps.create_ocp_projects([KAFKA_CLUSTER_NS_SUFFIX]),
            steps.create_kafka_cluster(KAFKA_CLUSTER_NAME, 2),
            {
                "label": "Storing your Apache Kafka settings",
                "task": tasks.store_kafka_credentials,
                "endpoint": workspace.config.ocp_api,
                "username": workspace.config.ocp_username,
                "fatal": True,
            },
            steps.create_env_files(),
        ]
        Console(items).run_items(action="Starting")

    def finish(self):
        steps = []
        Console(steps).run_items(action="Finishing")


def configure_workspace():
    """
    Prompt for configuration values
    """
    questions = [
        {
            "type": "input",
            "name": "workdir",
            "message": "Enter your workspace directory:",
            "default": workspace.config.workdir or str(DEFAULT_WORKDIR)
        },
        {
            "type": "input",
            "name": "ocp_api",
            "message": "Enter the OpenShift API endpoint:",
            "default": workspace.config.ocp_api or "https://"
        },
        {
            "type": "input",
            "name": "ocp_username",
            "message": "Enter the OpenShift username:",
            "default": workspace.config.ocp_username or ""
        },
        {
            "type": "password",
            "name": "ocp_password",
            "message": "Enter the OpenShift password:",
            "default": workspace.config.ocp_password or ""
        },
    ]

    echo("\nThis script configures the connection parameters to " +
         "access the OpenShift and Kafka clusters for your lab scripts.\n")

    answers = prompt(questions)
    workspace.configure(OcpClassroomConfig.from_dict(answers))
    echo(f"{workspace.config.workdir} set as workspace directory")


def todo(item: Dict):
    pass
